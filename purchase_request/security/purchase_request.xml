<?xml version="1.0" encoding="utf-8" ?>
<!-- Copyright 2018-2019 ForgeFlow, S.L.
     License LGPL-3.0 or later (http://www.gnu.org/licenses/lgpl-3.0) -->
<odoo>
    <record model="ir.module.category" id="module_category_purchase_request">
        <field name="name">Purchase Request</field>
        <field name="parent_id" ref="base.module_category_purchase_management" />
        <field name="sequence">10</field>
    </record>
    <!--
        Access Rights (separate groups, shown as checkboxes):
        - Storekeeper: Read-only PR access, restricted to assigned warehouse
        - Project Manager: Can create PRs, restricted to assigned warehouse
        - Warehouse Manager: Can approve PRs, cannot create PRs
        - PR Administrator: Full access
    -->
    <!-- Storekeeper - Read only access to PR, restricted inventory access to assigned warehouse -->
    <record id="group_purchase_request_viewer" model="res.groups">
        <field name="name">Storekeeper</field>
        <field name="implied_ids" eval="[(4, ref('base.group_user'))]" />
        <field name="category_id" ref="module_category_purchase_request" />
    </record>
    <!-- Project Manager - Can create PRs -->
    <record id="group_purchase_request_user" model="res.groups">
        <field name="name">Project Manager</field>
        <field name="implied_ids" eval="[(4, ref('base.group_user'))]" />
        <field name="category_id" ref="module_category_purchase_request" />
    </record>
    <!-- Warehouse Manager - Can approve PRs, cannot create PRs -->
    <record id="group_purchase_request_manager" model="res.groups">
        <field name="name">Warehouse Manager</field>
        <field name="implied_ids" eval="[(4, ref('base.group_user'))]" />
        <field name="category_id" ref="module_category_purchase_request" />
    </record>
    <!-- PR Administrator - Full access -->
    <record id="group_purchase_request_administrator" model="res.groups">
        <field name="name">PR Administrator</field>
        <field name="implied_ids" eval="[(4, ref('base.group_user'))]" />
        <field name="category_id" ref="module_category_purchase_request" />
    </record>
    <record model="ir.rule" id="purchase_request_comp_rule">
        <field name="name">Purchase Request multi-company</field>
        <field name="model_id" ref="model_purchase_request" />
        <field name="global" eval="True" />
        <field name="domain_force">
            ['|',('company_id','=',False),('company_id', 'in', company_ids)]
        </field>
    </record>
    <record model="ir.rule" id="purchase_request_line_comp_rule">
        <field name="name">Purchase Request Line multi-company</field>
        <field name="model_id" ref="model_purchase_request_line" />
        <field name="global" eval="True" />
        <field name="domain_force">
            ['|',('company_id','=',False),('company_id', 'in', company_ids)]
        </field>
    </record>
    <!-- Storekeeper (View Only) Rules - read only access, restricted to assigned warehouses -->
    <record id="purchase_request_viewer_rule" model="ir.rule">
        <field name="name">Purchase Request Storekeeper (View Only)</field>
        <field name="model_id" ref="model_purchase_request" />
        <field name="groups" eval="[(6,0, [ref('group_purchase_request_viewer')])]" />
        <field name="perm_read" eval="True" />
        <field name="perm_write" eval="False" />
        <field name="perm_create" eval="False" />
        <field name="perm_unlink" eval="False" />
        <field name="domain_force">[('picking_type_id.warehouse_id.storekeeper_id', '=', user.id)]</field>
    </record>
    <record id="purchase_request_line_viewer_rule" model="ir.rule">
        <field name="name">Purchase Request Line Storekeeper (View Only)</field>
        <field name="model_id" ref="model_purchase_request_line" />
        <field name="groups" eval="[(6,0, [ref('group_purchase_request_viewer')])]" />
        <field name="perm_read" eval="True" />
        <field name="perm_write" eval="False" />
        <field name="perm_create" eval="False" />
        <field name="perm_unlink" eval="False" />
        <field name="domain_force">[('request_id.picking_type_id.warehouse_id.storekeeper_id', '=', user.id)]</field>
    </record>
    <!-- Project Manager Rules - restricted to assigned warehouses -->
    <record id="purchase_request_followers_rule" model="ir.rule">
        <field name="name">Follow Purchase Request</field>
        <field name="model_id" ref="model_purchase_request" />
        <field name="groups" eval="[(6,0, [ref('group_purchase_request_user')])]" />
        <field name="perm_read" eval="True" />
        <field name="perm_write" eval="False" />
        <field name="perm_create" eval="False" />
        <field name="perm_unlink" eval="False" />
        <field name="domain_force">
            ['|', '|',
                ('requested_by','=',user.id),
                ('message_partner_ids', 'in', [user.partner_id.id]),
                ('picking_type_id.warehouse_id.project_manager_id', '=', user.id)]
        </field>
    </record>
    <record id="purchase_request_rule" model="ir.rule">
        <field name="name">Purchase Request Project Manager</field>
        <field name="model_id" ref="model_purchase_request" />
        <field name="groups" eval="[(6,0, [ref('group_purchase_request_user')])]" />
        <field name="perm_read" eval="True" />
        <field name="perm_write" eval="True" />
        <field name="perm_create" eval="True" />
        <field name="perm_unlink" eval="True" />
        <field name="domain_force">['|',
            ('requested_by','=',user.id),
            ('picking_type_id.warehouse_id.project_manager_id', '=', user.id)]</field>
    </record>
    <!-- Warehouse Manager Rules - can read/write all but cannot create -->
    <record id="purchase_request_manager_rule" model="ir.rule">
        <field name="name">Purchase Request Warehouse Manager</field>
        <field name="model_id" ref="model_purchase_request" />
        <field name="groups" eval="[(6,0, [ref('group_purchase_request_manager')])]" />
        <field name="perm_read" eval="True" />
        <field name="perm_write" eval="True" />
        <field name="perm_create" eval="False" />
        <field name="perm_unlink" eval="True" />
    </record>
    <!-- PR Administrator Rules - full access -->
    <record id="purchase_request_administrator_rule" model="ir.rule">
        <field name="name">Purchase Request Administrator</field>
        <field name="model_id" ref="model_purchase_request" />
        <field name="groups" eval="[(6,0, [ref('group_purchase_request_administrator')])]" />
        <field name="perm_read" eval="True" />
        <field name="perm_write" eval="True" />
        <field name="perm_create" eval="True" />
        <field name="perm_unlink" eval="True" />
    </record>
    <!-- Purchase Request Line Rules - restricted to assigned warehouses -->
    <record id="purchase_request_line_followers_rule" model="ir.rule">
        <field name="name">Follow Purchase Request Line</field>
        <field name="model_id" ref="model_purchase_request_line" />
        <field name="groups" eval="[(6,0, [ref('group_purchase_request_user')])]" />
        <field name="perm_read" eval="True" />
        <field name="perm_write" eval="False" />
        <field name="perm_create" eval="False" />
        <field name="perm_unlink" eval="False" />
        <field name="domain_force">
            ['|', '|',
                ('request_id.requested_by','=',user.id),
                ('request_id.message_partner_ids', 'in', [user.partner_id.id]),
                ('request_id.picking_type_id.warehouse_id.project_manager_id', '=', user.id)]
        </field>
    </record>
    <record id="purchase_request_line_rule" model="ir.rule">
        <field name="name">Purchase Request Line Project Manager</field>
        <field name="model_id" ref="model_purchase_request_line" />
        <field name="groups" eval="[(6,0, [ref('group_purchase_request_user')])]" />
        <field name="perm_read" eval="True" />
        <field name="perm_write" eval="True" />
        <field name="perm_create" eval="True" />
        <field name="perm_unlink" eval="True" />
        <field name="domain_force">['|',
            ('request_id.requested_by','=',user.id),
            ('request_id.picking_type_id.warehouse_id.project_manager_id', '=', user.id)]</field>
    </record>
    <!-- Warehouse Manager Line Rules - can read/write all but cannot create -->
    <record id="purchase_request_line_manager_rule" model="ir.rule">
        <field name="name">Purchase Request Line Warehouse Manager</field>
        <field name="model_id" ref="model_purchase_request_line" />
        <field name="groups" eval="[(6,0, [ref('group_purchase_request_manager')])]" />
        <field name="perm_read" eval="True" />
        <field name="perm_write" eval="True" />
        <field name="perm_create" eval="False" />
        <field name="perm_unlink" eval="True" />
    </record>
    <!-- PR Administrator Line Rules - full access -->
    <record id="purchase_request_line_administrator_rule" model="ir.rule">
        <field name="name">Purchase Request Line Administrator</field>
        <field name="model_id" ref="model_purchase_request_line" />
        <field name="groups" eval="[(6,0, [ref('group_purchase_request_administrator')])]" />
        <field name="perm_read" eval="True" />
        <field name="perm_write" eval="True" />
        <field name="perm_create" eval="True" />
        <field name="perm_unlink" eval="True" />
    </record>
    <!-- Storekeeper Stock Rules - restrict to assigned warehouses -->
    <record id="storekeeper_warehouse_rule" model="ir.rule">
        <field name="name">Storekeeper - Warehouse Access</field>
        <field name="model_id" ref="stock.model_stock_warehouse" />
        <field name="groups" eval="[(6,0, [ref('group_purchase_request_viewer')])]" />
        <field name="perm_read" eval="True" />
        <field name="perm_write" eval="False" />
        <field name="perm_create" eval="False" />
        <field name="perm_unlink" eval="False" />
        <field name="domain_force">[('storekeeper_id', '=', user.id)]</field>
    </record>
    <record id="storekeeper_location_rule" model="ir.rule">
        <field name="name">Storekeeper - Location Access</field>
        <field name="model_id" ref="stock.model_stock_location" />
        <field name="groups" eval="[(6,0, [ref('group_purchase_request_viewer')])]" />
        <field name="perm_read" eval="True" />
        <field name="perm_write" eval="False" />
        <field name="perm_create" eval="False" />
        <field name="perm_unlink" eval="False" />
        <field name="domain_force">[('warehouse_id.storekeeper_id', '=', user.id)]</field>
    </record>
    <record id="storekeeper_quant_rule" model="ir.rule">
        <field name="name">Storekeeper - Stock Quant Access</field>
        <field name="model_id" ref="stock.model_stock_quant" />
        <field name="groups" eval="[(6,0, [ref('group_purchase_request_viewer')])]" />
        <field name="perm_read" eval="True" />
        <field name="perm_write" eval="False" />
        <field name="perm_create" eval="False" />
        <field name="perm_unlink" eval="False" />
        <field name="domain_force">[('location_id.warehouse_id.storekeeper_id', '=', user.id)]</field>
    </record>
    <record id="storekeeper_picking_rule" model="ir.rule">
        <field name="name">Storekeeper - Picking Access</field>
        <field name="model_id" ref="stock.model_stock_picking" />
        <field name="groups" eval="[(6,0, [ref('group_purchase_request_viewer')])]" />
        <field name="perm_read" eval="True" />
        <field name="perm_write" eval="True" />
        <field name="perm_create" eval="False" />
        <field name="perm_unlink" eval="False" />
        <field name="domain_force">['|',
            ('location_id.warehouse_id.storekeeper_id', '=', user.id),
            ('location_dest_id.warehouse_id.storekeeper_id', '=', user.id)]</field>
    </record>
    <record id="storekeeper_move_rule" model="ir.rule">
        <field name="name">Storekeeper - Stock Move Access</field>
        <field name="model_id" ref="stock.model_stock_move" />
        <field name="groups" eval="[(6,0, [ref('group_purchase_request_viewer')])]" />
        <field name="perm_read" eval="True" />
        <field name="perm_write" eval="True" />
        <field name="perm_create" eval="False" />
        <field name="perm_unlink" eval="False" />
        <field name="domain_force">['|',
            ('location_id.warehouse_id.storekeeper_id', '=', user.id),
            ('location_dest_id.warehouse_id.storekeeper_id', '=', user.id)]</field>
    </record>
    <record id="storekeeper_picking_type_rule" model="ir.rule">
        <field name="name">Storekeeper - Picking Type Access</field>
        <field name="model_id" ref="stock.model_stock_picking_type" />
        <field name="groups" eval="[(6,0, [ref('group_purchase_request_viewer')])]" />
        <field name="perm_read" eval="True" />
        <field name="perm_write" eval="False" />
        <field name="perm_create" eval="False" />
        <field name="perm_unlink" eval="False" />
        <field name="domain_force">[('warehouse_id.storekeeper_id', '=', user.id)]</field>
    </record>
</odoo>
